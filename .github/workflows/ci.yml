name: CI/CD Pipeline

# Trigger conditions
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

# Environment variables
env:
  NODE_VERSION: '20.x'

jobs:
  # Job 1: Install dependencies and run tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]
    
    steps:
      # Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Node.js with the specified version
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      # Cache node_modules to speed up subsequent runs
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Install project dependencies
      - name: Install dependencies
        run: npm ci

      # Run linting checks
      - name: Run linter
        run: npm run lint
        continue-on-error: true

      # Run code formatting check
      - name: Check code format
        run: npm run format -- --check
        continue-on-error: true

      # Run the test suite
      - name: Run tests
        run: npm test -- --run

      # Run benchmark tests
      - name: Run benchmark tests
        run: npm run test:benchmark
        continue-on-error: true

      # Upload test results as artifacts
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.node-version }}
          path: |
            coverage/
            test-results/
          retention-days: 30

  # Job 2: Generate and report code coverage
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      # Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Cache dependencies
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Generate coverage report
      - name: Generate coverage report
        run: npm test -- --run --coverage
        continue-on-error: true

      # Upload coverage to Codecov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      # Generate coverage badge
      - name: Generate coverage badge
        run: |
          # Extract coverage percentage from coverage report
          COVERAGE=$(cat coverage/coverage-summary.json 2>/dev/null | grep -o '"lines":{[^}]*"pct":[0-9.]*' | grep -o '[0-9.]*$' | head -1 || echo "0")
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
          
          # Create badge URL
          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            COLOR="brightgreen"
          elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
            COLOR="yellow"
          else
            COLOR="red"
          fi
          
          echo "BADGE_COLOR=$COLOR" >> $GITHUB_ENV
        continue-on-error: true

      # Upload coverage artifacts
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      # Create coverage comment on PR
      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = fs.existsSync('./coverage/coverage-summary.json')
              ? JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8')).total.lines.pct
              : 'N/A';
            
            const comment = `## Coverage Report
            
            - **Lines**: ${coverage}%
            - **Statements**: Check artifacts for details
            - **Branches**: Check artifacts for details
            - **Functions**: Check artifacts for details
            
            [View full coverage report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
        continue-on-error: true

  # Job 3: Deploy to production
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, coverage]
    
    # Only deploy on push to main branch
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      # Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Cache dependencies
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Build the project (if needed)
      - name: Build project
        run: npm run build
        continue-on-error: true

      # Deploy to Vercel (uncomment and configure if using Vercel)
      # - name: Deploy to Vercel
      #   uses: vercel/action@master
      #   with:
      #     vercel-token: ${{ secrets.VERCEL_TOKEN }}
      #     vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
      #     vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}

      # Deploy to Render (uncomment and configure if using Render)
      # - name: Deploy to Render
      #   run: |
      #     curl -X POST https://api.render.com/deploy/srv-${{ secrets.RENDER_SERVICE_ID }}?key=${{ secrets.RENDER_API_KEY }}

      # Deploy to Docker Hub (uncomment and configure if using Docker)
      # - name: Build and push Docker image
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: .
      #     push: true
      #     tags: ${{ secrets.DOCKER_USERNAME }}/arx:latest
      #     username: ${{ secrets.DOCKER_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}

      # Deploy to GitHub Pages (uncomment if deploying documentation)
      # - name: Deploy to GitHub Pages
      #   uses: peaceiris/actions-gh-pages@v3
      #   with:
      #     github_token: ${{ secrets.GH_TOKEN }}
      #     publish_dir: ./docs

      # Generic deployment notification
      - name: Deployment notification
        run: |
          echo "Deployment job completed successfully!"
          echo "Configure deployment steps in .github/workflows/ci.yml"
          echo "Supported platforms:"
          echo "  - Vercel (uncomment Vercel deployment step)"
          echo "  - Render (uncomment Render deployment step)"
          echo "  - Docker Hub (uncomment Docker deployment step)"
          echo "  - GitHub Pages (uncomment GitHub Pages deployment step)"

      # Create deployment status check
      - name: Create deployment status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment.id || 0,
              state: 'success',
              description: 'Deployment completed successfully',
              environment_url: 'https://github.com/${{ github.repository }}'
            });
        continue-on-error: true

  # Job 4: Generate and update coverage badge
  badge:
    name: Update Coverage Badge
    runs-on: ubuntu-latest
    needs: coverage
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      # Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      # Download coverage artifacts
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      # Generate coverage badge
      - name: Generate coverage badge
        run: |
          # Extract coverage percentage
          COVERAGE=$(cat coverage/coverage-summary.json 2>/dev/null | grep -o '"lines":{[^}]*"pct":[0-9.]*' | grep -o '[0-9.]*$' | head -1 || echo "0")
          
          # Determine badge color based on coverage
          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            COLOR="brightgreen"
          elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
            COLOR="yellow"
          else
            COLOR="red"
          fi
          
          # Create badge URL
          BADGE_URL="https://img.shields.io/badge/coverage-${COVERAGE}%25-${COLOR}"
          
          # Update README with badge
          if grep -q "coverage-badge" README.md; then
            sed -i "s|!\[coverage\].*|![coverage](${BADGE_URL})|" README.md
          else
            # Add badge to README if not present
            sed -i "1s/^/![coverage](${BADGE_URL})\n\n/" README.md
          fi
        continue-on-error: true

      # Commit and push badge update
      - name: Commit and push badge
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add README.md
            git commit -m "chore: update coverage badge [skip ci]"
            git push
          fi
        continue-on-error: true

  # Job 5: Notify on workflow failure
  on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    if: failure()
    needs: [test, coverage, deploy, badge]
    
    steps:
      - name: Send failure notification
        run: |
          echo "Workflow failed! Check the logs for details."
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
